<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Tank 1990</title>
	<script src="../build/bu.min.js"></script>
	<script type="text/javascript">
		var bu = new Bu.App({
			renderer: {
				width: 512,
				height: 512,
				imageSmoothing: false,
			},
			data: {
				font: new Bu.SpriteSheet('assets/sprite-sheets/nes-font.json'),
				sheet: new Bu.SpriteSheet('assets/sprite-sheets/tank.json'),
				highScore1: 0,
				highScore2: 20000,
				scrollAnim: new Bu.Animation({
					duration: 3,
					update: function(anim) {
						return this.position.y = (1 - anim.t) * 512;
					}
				}),
				selectedMenu: 0,
				level: 1,

				scenes: {
					MENU: 0,
					LEVEL: 1,
					PLAY: 2,
					selected: 0,
				},
				tankMoveSpeed: 2,
			},
			objects: function() {
				let textHighScoreValue1 = new Bu.PointText(this.highScore1 + "", 32 * 5.5, 32);
				let textHighScoreValue2 = new Bu.PointText(this.highScore2 + "", 32 * 10.5, 32);

				return {
					sceneMenu: new Bu.Scene(),
					sceneLevel: new Bu.Scene(),
					scenePlay: new Bu.Scene(),

					txtHighScoreTitle1: new Bu.PointText("I-", 32, 32).setAlign('++'),
					txtHighScoreValue1: textHighScoreValue1.setAlign('-+'),
					txtHighScoreTitle2: new Bu.PointText("HI-", 32 * 6, 32).setAlign('++'),
					txtHighScoreValue2: textHighScoreValue2.setAlign('-+'),
					txt1P: new Bu.PointText("1 PLAYER", 32 * 5, 32 * 10).setAlign('++'),
					txt2P: new Bu.PointText("2 PLAYERS", 32 * 5, 32 * 11).setAlign('++'),
					txtConstruction: new Bu.PointText("CONSTRUCTION", 32 * 5, 32 * 12).setAlign('++'),
					txtCopyright: new Bu.PointText("(C) 1990", 32 * 5, 32 * 13.5).setAlign('++'),
					txtAuthor: new Bu.PointText("Recreated By Jarvis Niu", 32 * 2, 32 * 15).setAlign('++'),

					txtStage: new Bu.PointText("Stage " + this.level, 32 * 6, 32 * 8).setAlign('++'),

					selector: new Bu.Image(null, 32 * 4.2, 32 * 10.25, 32, 32),
					field: new Bu.Rectangle(0, 0, 384, 384).translate(40, 40).fill('black'),
					tank1P: new Bu.Image(null, 0, 0, 32, 32).translate(192 - 32, 384 - 16).rotate(Bu.d2r(-90)),
					base: new Bu.Image(null, 192, 384 - 16, 32, 32),
				}
			},
			hierarchy: {
				sceneMenu: {
					txtHighScoreTitle1: {},
					txtHighScoreValue1: {},
					txtHighScoreTitle2: {},
					txtHighScoreValue2: {},
					txt1P: {},
					txt2P: {},
					txtConstruction: {},
					txtCopyright: {},
					txtAuthor: {},
					selector: {},
				},
				sceneLevel: {
					txtStage: {},
				},
				scenePlay: {
					field: {
						tank1P: {},
						base: {},
					},
				},
			},
			init: function() {
				let o = this.$objects;

				this.$renderer.scene = o.sceneMenu;

				Bu.DEFAULT_FONT = this.font;
				this.sheet.once('loaded', () => {
					o.tank1P.image = o.selector.image = this.sheet.getFrameImage('tank_p1');
					o.base.image = this.sheet.getFrameImage('base');
				});

				this.scrollAnimTask = this.scrollAnim.applyTo(o.sceneMenu);
				window.focus();

				o.sceneMenu.background = 'black';
				o.sceneLevel.background = o.scenePlay.background = 'silver';
			},
			update: function() {
				let o = this.$objects;

				if (this.scenes.selected == this.scenes.PLAY) {
					if (this.$inputManager.isKeyDown("Left")) {
						o.tank1P.position.x += -this.tankMoveSpeed;
						o.tank1P.rotation = Bu.d2r(180);
						if (o.tank1P.position.x < 16) o.tank1P.position.x = 16;
					} else if (this.$inputManager.isKeyDown("Right")) {
						o.tank1P.position.x += this.tankMoveSpeed;
						o.tank1P.rotation = Bu.d2r(0);
						if (o.tank1P.position.x > o.field.size.width - 16) o.tank1P.position.x = o.field.size.width - 16;
					} else if (this.$inputManager.isKeyDown("Up")) {
						o.tank1P.position.y += -this.tankMoveSpeed;
						o.tank1P.rotation = Bu.d2r(-90);
						if (o.tank1P.position.y < 16) o.tank1P.position.y = 16;
					} else if (this.$inputManager.isKeyDown("Down")) {
						o.tank1P.position.y += this.tankMoveSpeed;
						o.tank1P.rotation = Bu.d2r(90);
						if (o.tank1P.position.y > o.field.size.height - 16) o.tank1P.position.y = o.field.size.height - 16;
					}
				}
			},
			methods: {
				switchMenu: function(delta) {
					this.selectedMenu += delta;
					if (this.selectedMenu < 0)
						this.selectedMenu = 2;
					else if (this.selectedMenu > 2)
						this.selectedMenu = 0;
					this.$objects.selector.position.y = 32 * (10.25 + this.selectedMenu);
				},
			},
			events: {
				keydown: function() {
					this.scrollAnimTask.end();
				},
				'keydown.ArrowUp': function() {
					if (this.scenes.selected == this.scenes.MENU) {
						this.switchMenu(-1);
					} else if (this.scenes.selected == this.scenes.LEVEL) {
						this.level += 1;
						this.$objects.txtStage.text = 'Stage ' + this.level;
					}
				},
				'keydown.ArrowDown': function() {
					if (this.scenes.selected == this.scenes.MENU) {
						this.switchMenu(1);
					} else if (this.scenes.selected == this.scenes.LEVEL) {
						this.level -= 1;
						this.$objects.txtStage.text = 'Stage ' + this.level;
					}
				},
				'keydown.Enter': function() {
					let o = this.$objects;
					if (this.scenes.selected == this.scenes.MENU) {
						if (this.scrollAnimTask.finished) {
							this.$renderer.scene = o.sceneLevel;
							this.scenes.selected = this.scenes.LEVEL;
						} else {
							this.scrollAnimTask.end();
						}
					} else if (this.scenes.selected == this.scenes.LEVEL) {
						this.$renderer.scene = o.scenePlay;
						this.scenes.selected = this.scenes.PLAY;
					} else {
						this.$renderer.scene = o.sceneMenu;
						this.scenes.selected = this.scenes.MENU;
					}
				},
			},
		});
	</script>
</head>

<body>
	<div id="info">This is copy of NES game "Battle City" in 1985.</div>
</body>

</html>
