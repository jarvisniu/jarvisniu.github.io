<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Weblab</title>
        <link rel="stylesheet" type="text/css" href="index.css">

        <script src="//cdn.bootcss.com/ace/1.2.5/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="//cdn.bootcss.com/ace/1.2.5/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
        <script src="//cdn.bootcss.com/ace/1.2.5/mode-html.js" type="text/javascript" charset="utf-8"></script>
        <script src="//cdn.bootcss.com/ace/1.2.5/mode-css.js" type="text/javascript" charset="utf-8"></script>

        <script type="text/javascript">

        	var CDN_D3 = "http://d3js.org/d3.v3.min.js";
        	var CDN_THREE = "http://threejs.org/build/three.js";

            var txtConsoleInput;
            var preview, previewConsole, divConsoleLog;
            var previewDocument, preveiwScriptLink, previewScript, previewCSS;

            var aceScript, aceStyle, aceHTML;

            function refreshPreview() {
                previewDocument.body.innerHTML = aceHTML.session.getValue();
                divConsoleLog.innerHTML = "";

                savePage();

                refreshPreviewCSS();
                refreshPreviewCode();
            }

            function refreshPreviewCode() {
                previewDocument.head.removeChild(previewScript);
                previewScript = document.createElement("script");
                previewScript.innerHTML = aceScript.session.getValue();
                previewDocument.head.appendChild(previewScript);
            }

            function refreshPreviewCSS() {
                previewDocument.head.removeChild(previewCSS);
                previewCSS = document.createElement("style");
                previewCSS.setAttribute("type", "text/css");
                previewCSS.innerHTML = aceStyle.session.getValue();
                previewDocument.head.appendChild(previewCSS);
            }

            function savePage() {
            	localStorage.html = aceHTML.session.getValue();
            	localStorage.script = aceScript.session.getValue();
            	localStorage.style = aceStyle.session.getValue();
            }

            function loadPage() {
            	aceScript.session.setValue(localStorage.script || "");
            	aceHTML.session.setValue(localStorage.html || "");
                aceStyle.session.setValue(localStorage.style || "");
            }

            function executeConsoleInput() {
        		var inputValue, outputValue;

        		inputValue = txtConsoleInput.value;
        		try	{
        			outputValue = preview.contentWindow.eval(inputValue);
        			previewConsole.log('> ' + inputValue + '<br>< ' + outputValue);
        		} catch (e) {
        			previewConsole.log('> ' + inputValue);
        			previewConsole.error('< ' + e.message);
        		}
        		txtConsoleInput.value = '';
            }

            document.addEventListener("DOMContentLoaded", function() {
                txtConsoleInput = document.getElementById("txtConsoleInput");
                preview = document.getElementById("preview");
                divConsoleLog = document.getElementById("divConsoleLog");
                previewDocument = preview.contentWindow.document;
                previewConsole = preview.contentWindow.console;

                previewScript = document.createElement("script");
                previewDocument.head.appendChild(previewScript);
                previewCSS = document.createElement("style");
                previewDocument.head.appendChild(previewCSS);

                previewScriptLink = document.createElement("script");
                previewScriptLink.addEventListener("load", refreshPreview);
                // previewScriptLink.setAttribute("src", CDN_THREE);
                previewScriptLink.setAttribute("src", CDN_D3);
                previewDocument.head.appendChild(previewScriptLink);


                previewConsole.log = previewConsole.info = function() {
                	divConsoleLog.innerHTML += "<p>" + Array.prototype.slice.call(arguments).join(", ") + "</p>";
                }
                previewConsole.error = function() {
                	divConsoleLog.innerHTML += '<p class="error">' + Array.prototype.slice.call(arguments).join(", ") + "</p>";
                }
                previewConsole.warn = function() {
                	divConsoleLog.innerHTML += '<p class="warn">' + Array.prototype.slice.call(arguments).join(", ") + "</p>";
                }

                aceScript = ace.edit("divCode");
                var JavaScriptMode = ace.require("ace/mode/javascript").Mode;
                aceScript.session.setMode(new JavaScriptMode());

                aceHTML = ace.edit("divHTML");
                var HTMLMode = ace.require("ace/mode/html").Mode;
                aceHTML.session.setMode(new HTMLMode());

                aceStyle = ace.edit("divStyle");
                var CSSMode = ace.require("ace/mode/css").Mode;
                aceStyle.session.setMode(new CSSMode());

                loadPage();

                aceHTML.session.on("change", refreshPreview);
                aceStyle.session.on("change", refreshPreview);
                aceScript.session.on("change", refreshPreview);

                txtConsoleInput.addEventListener("keyup", function(e) {
                	if (e.keyIdentifier == 'Enter') executeConsoleInput();
                });
            });

        </script>
    </head>
    <body>
    	<div id="divLeft">
            <div id="divCode"></div>
        	<div id="divConsole">
        		<div id="divConsoleLog"></div>
        		<div id="divConsoleInput">
        			<input type="text" id="txtConsoleInput">
        		</div>
        	</div>
    	</div>
    	<div id="divRight">
        	<div id="divPreview">
	        	<iframe id="preview"></iframe>
        	</div>
        	<div id="divCorner">
		        <div id="divHTML"></div>
		        <div id="divStyle"></div>
	    	</div>
    	</div>
    </body>
</html>
